# éŸ³é¢‘ç›‘å¬å·¥ç¨‹å®ç°æ–¹æ¡ˆ

## ğŸ“‹ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç•Œé¢ï¼ˆå‰ç«¯ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ éŸ³é¢‘æ³¢å½¢ â”‚  â”‚ å¯¹è¯é¢æ¿ â”‚  â”‚ æ§åˆ¶æŒ‰é’® â”‚  â”‚ çŠ¶æ€æ˜¾ç¤º â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   WebSocket æœåŠ¡å™¨ï¼ˆFastAPIï¼‰                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è¿æ¥ç®¡ç† â”‚ æ¶ˆæ¯è·¯ç”± â”‚ çŠ¶æ€åŒæ­¥ â”‚ é”™è¯¯å¤„ç† â”‚ å¿ƒè·³   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   éŸ³é¢‘å¤„ç†å±‚ï¼ˆPythonï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ éŸ³é¢‘é‡‡é›†æ¨¡å— â”‚â†’â”‚ éŸ³é¢‘é¢„å¤„ç†   â”‚â†’â”‚ æ ¼å¼è½¬æ¢     â”‚     â”‚
â”‚  â”‚ (PyAudio)   â”‚  â”‚ (é™å™ª/VAD)   â”‚  â”‚ (PCM 16kHz)  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é˜¿é‡Œäº‘ DashScope ASR æœåŠ¡                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å®æ—¶è¯­éŸ³è¯†åˆ« â”‚ VAD æ–­å¥ â”‚ æµå¼è¿”å› â”‚ é”™è¯¯é‡è¯•      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡å¤„ç†å±‚ï¼ˆå·²å®Œæˆï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ è§’è‰²è¯†åˆ«     â”‚â†’â”‚ æ„å›¾ç†è§£     â”‚â†’â”‚ å›å¤ç”Ÿæˆ     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å®æ–½è®¡åˆ’

### Phase 1: éŸ³é¢‘é‡‡é›†æ¨¡å—ï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä»éº¦å…‹é£æˆ–ç³»ç»ŸéŸ³é¢‘æ•è·éŸ³é¢‘æµ

**æŠ€æœ¯é€‰å‹**ï¼š
- **æ–¹æ¡ˆ A**ï¼šPyAudioï¼ˆè·¨å¹³å°ï¼Œæˆç†Ÿï¼‰
- **æ–¹æ¡ˆ B**ï¼šsounddeviceï¼ˆæ›´ç°ä»£ï¼Œæ¨èï¼‰
- **æ–¹æ¡ˆ C**ï¼šWeb Audio APIï¼ˆå‰ç«¯é‡‡é›†ï¼Œç®€å•ï¼‰

**æ¨è**ï¼šæ–¹æ¡ˆ Cï¼ˆå‰ç«¯é‡‡é›†ï¼‰+ æ–¹æ¡ˆ Bï¼ˆåç«¯å¤‡ç”¨ï¼‰

**å®ç°æ­¥éª¤**ï¼š
1. å‰ç«¯ä½¿ç”¨ `navigator.mediaDevices.getUserMedia()` é‡‡é›†éŸ³é¢‘
2. ä½¿ç”¨ `AudioContext` å¤„ç†éŸ³é¢‘æµ
3. è½¬æ¢ä¸º PCM æ ¼å¼
4. é€šè¿‡ WebSocket å‘é€åˆ°åç«¯

### Phase 2: WebSocket å®æ—¶é€šä¿¡ï¼ˆ1å¤©ï¼‰

**ç›®æ ‡**ï¼šå»ºç«‹ç¨³å®šçš„åŒå‘å®æ—¶é€šä¿¡

**åŠŸèƒ½**ï¼š
- éŸ³é¢‘æ•°æ®ä¸Šä¼ ï¼ˆå‰ç«¯ â†’ åç«¯ï¼‰
- è¯†åˆ«ç»“æœæ¨é€ï¼ˆåç«¯ â†’ å‰ç«¯ï¼‰
- çŠ¶æ€åŒæ­¥
- å¿ƒè·³ä¿æ´»
- æ–­çº¿é‡è¿

### Phase 3: ASR æœåŠ¡é›†æˆï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šè¿æ¥é˜¿é‡Œäº‘ DashScope å®æ—¶è¯­éŸ³è¯†åˆ«

**åŠŸèƒ½**ï¼š
- WebSocket è¿æ¥åˆ° DashScope
- æµå¼éŸ³é¢‘ä¸Šä¼ 
- å®æ—¶è½¬å†™ç»“æœå¤„ç†
- VAD æ–­å¥
- é”™è¯¯å¤„ç†å’Œé‡è¯•

### Phase 4: ç«¯åˆ°ç«¯é›†æˆï¼ˆ1å¤©ï¼‰

**ç›®æ ‡**ï¼šæ‰“é€šå®Œæ•´æµç¨‹

**æµç¨‹**ï¼š
```
å‰ç«¯é‡‡é›†éŸ³é¢‘ â†’ WebSocket ä¼ è¾“ â†’ ASR è¯†åˆ« â†’ è§’è‰²åˆ¤æ–­ â†’ å›å¤ç”Ÿæˆ â†’ å‰ç«¯æ˜¾ç¤º
```

---

## ğŸ’» æŠ€æœ¯å®ç°

### 1. å‰ç«¯éŸ³é¢‘é‡‡é›†ï¼ˆæ¨èæ–¹æ¡ˆï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€å®‰è£…è™šæ‹ŸéŸ³é¢‘è®¾å¤‡
- âœ… è·¨å¹³å°å…¼å®¹
- âœ… ç”¨æˆ·æˆæƒæ¸…æ™°
- âœ… å®ç°ç®€å•

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// frontend/src/services/audioCapture.ts
class AudioCaptureService {
  private audioContext: AudioContext | null = null;
  private mediaStream: MediaStream | null = null;
  private processor: ScriptProcessorNode | null = null;
  
  async startCapture(onAudioData: (data: Float32Array) => void) {
    // 1. è¯·æ±‚éº¦å…‹é£æƒé™
    this.mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        sampleRate: 16000,
        channelCount: 1,
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
      }
    });
    
    // 2. åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
    this.audioContext = new AudioContext({ sampleRate: 16000 });
    const source = this.audioContext.createMediaStreamSource(this.mediaStream);
    
    // 3. åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨
    this.processor = this.audioContext.createScriptProcessor(4096, 1, 1);
    
    this.processor.onaudioprocess = (e) => {
      const audioData = e.inputBuffer.getChannelData(0);
      onAudioData(audioData);
    };
    
    source.connect(this.processor);
    this.processor.connect(this.audioContext.destination);
  }
  
  stopCapture() {
    if (this.processor) {
      this.processor.disconnect();
    }
    if (this.mediaStream) {
      this.mediaStream.getTracks().forEach(track => track.stop());
    }
    if (this.audioContext) {
      this.audioContext.close();
    }
  }
}
```

### 2. åç«¯éŸ³é¢‘é‡‡é›†ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼šéœ€è¦æ•è·ç³»ç»ŸéŸ³é¢‘ï¼ˆä¼šè®®è½¯ä»¶å£°éŸ³ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# backend/core/audio_capture.py
import sounddevice as sd
import numpy as np
from queue import Queue

class AudioCapture:
    def __init__(self, sample_rate=16000, channels=1, chunk_size=1024):
        self.sample_rate = sample_rate
        self.channels = channels
        self.chunk_size = chunk_size
        self.audio_queue = Queue()
        self.stream = None
    
    def audio_callback(self, indata, frames, time, status):
        """éŸ³é¢‘å›è°ƒå‡½æ•°"""
        if status:
            print(f"éŸ³é¢‘çŠ¶æ€: {status}")
        
        # å°†éŸ³é¢‘æ•°æ®æ”¾å…¥é˜Ÿåˆ—
        self.audio_queue.put(indata.copy())
    
    def start(self):
        """å¼€å§‹é‡‡é›†"""
        self.stream = sd.InputStream(
            samplerate=self.sample_rate,
            channels=self.channels,
            callback=self.audio_callback,
            blocksize=self.chunk_size
        )
        self.stream.start()
    
    def stop(self):
        """åœæ­¢é‡‡é›†"""
        if self.stream:
            self.stream.stop()
            self.stream.close()
    
    def get_audio_chunk(self):
        """è·å–éŸ³é¢‘å—"""
        if not self.audio_queue.empty():
            return self.audio_queue.get()
        return None
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

æˆ‘å»ºè®®æˆ‘ä»¬æŒ‰ä»¥ä¸‹é¡ºåºå®ç°ï¼š

**ç¬¬ 1 æ­¥**ï¼šå®ç°å‰ç«¯éŸ³é¢‘é‡‡é›†ï¼ˆæœ€ç®€å•ï¼Œæœ€å¿«è§æ•ˆï¼‰
- åˆ›å»º `AudioCaptureService`
- é›†æˆåˆ°ç°æœ‰å‰ç«¯
- æµ‹è¯•éŸ³é¢‘é‡‡é›†

**ç¬¬ 2 æ­¥**ï¼šå®Œå–„ WebSocket é€šä¿¡
- éŸ³é¢‘æ•°æ®ä¼ è¾“
- å®æ—¶çŠ¶æ€åŒæ­¥

**ç¬¬ 3 æ­¥**ï¼šé›†æˆ DashScope ASR
- è¿æ¥ ASR æœåŠ¡
- å¤„ç†è¯†åˆ«ç»“æœ

**ç¬¬ 4 æ­¥**ï¼šç«¯åˆ°ç«¯æµ‹è¯•
- å®Œæ•´æµç¨‹éªŒè¯
- æ€§èƒ½ä¼˜åŒ–

---

## â“ å…³é”®å†³ç­–ç‚¹

åœ¨å¼€å§‹å®ç°å‰ï¼Œéœ€è¦ç¡®è®¤å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

1. **éŸ³é¢‘æºé€‰æ‹©**ï¼š
   - é€‰é¡¹ Aï¼šåªé‡‡é›†éº¦å…‹é£ï¼ˆç®€å•ï¼Œä½†å¬ä¸åˆ°ä¼šè®®è½¯ä»¶çš„å£°éŸ³ï¼‰
   - é€‰é¡¹ Bï¼šé‡‡é›†ç³»ç»ŸéŸ³é¢‘ï¼ˆå¤æ‚ï¼Œéœ€è¦è™šæ‹Ÿè®¾å¤‡ï¼Œä½†èƒ½å¬åˆ°æ‰€æœ‰å£°éŸ³ï¼‰
   - é€‰é¡¹ Cï¼šä¸¤è€…éƒ½æ”¯æŒï¼ˆæœ€çµæ´»ï¼‰

2. **é‡‡é›†ä½ç½®**ï¼š
   - é€‰é¡¹ Aï¼šå‰ç«¯é‡‡é›†ï¼ˆæ¨èï¼Œç®€å•ï¼‰
   - é€‰é¡¹ Bï¼šåç«¯é‡‡é›†ï¼ˆå¤æ‚ï¼Œä½†æ›´çµæ´»ï¼‰

3. **å®æ—¶æ€§è¦æ±‚**ï¼š
   - å»¶è¿Ÿç›®æ ‡ï¼š< 2 ç§’ï¼Ÿ
   - æ˜¯å¦éœ€è¦æµå¼æ˜¾ç¤ºè¯†åˆ«ç»“æœï¼Ÿ

---

**ä½ çš„é€‰æ‹©æ˜¯ä»€ä¹ˆï¼Ÿ**

1. éŸ³é¢‘æºï¼šAï¼ˆéº¦å…‹é£ï¼‰/ Bï¼ˆç³»ç»ŸéŸ³é¢‘ï¼‰/ Cï¼ˆéƒ½æ”¯æŒï¼‰
2. é‡‡é›†ä½ç½®ï¼šAï¼ˆå‰ç«¯ï¼‰/ Bï¼ˆåç«¯ï¼‰
3. æˆ‘ä»¬ä»å“ªä¸€æ­¥å¼€å§‹ï¼Ÿ

æˆ–è€…æˆ‘ç›´æ¥æŒ‰ç…§æœ€ä½³å®è·µï¼ˆå‰ç«¯é‡‡é›†éº¦å…‹é£ + æµå¼è¯†åˆ«ï¼‰å¼€å§‹å®ç°ï¼Ÿ

